<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Отчет — Перехват заказов на приемке</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f5f6fb;
    --card:#ffffff;
    --text:#101828;
    --muted:#667085;
    --line:#eaecf0;
    --shadow:0 6px 20px rgba(16,24,40,.08);
    --radius:16px;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
  header{
    background:linear-gradient(90deg,#5a3cff,#8c6cff);
    color:#fff;
    padding:18px 18px 16px;
    box-shadow:0 6px 20px rgba(0,0,0,.18);
    position:sticky; top:0; z-index:20;
  }
  .header-row{ display:flex; justify-content:space-between; align-items:flex-start; gap:14px; flex-wrap:wrap; }
  .title-wrap{ display:flex; flex-direction:column; gap:6px; }
  h1{ margin:0; font-size:18px; font-weight:700; letter-spacing:.2px; }
  .subtitle{ font-size:12px; opacity:.9; }

  .filters{
    display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;
    background:rgba(255,255,255,.12);
    padding:10px; border-radius:14px;
    border:1px solid rgba(255,255,255,.18);
  }
  .filter{ display:flex; flex-direction:column; gap:6px; }
  label{ font-size:11px; opacity:.95; }
  select,input{
    border-radius:10px;
    border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.16);
    color:#fff;
    padding:8px 10px;
    outline:none;
    min-width:160px;
  }
  input[type="date"]{ min-width:145px; }
  select option{ color:#111; }
  .btn{
    padding:9px 12px;
    border:none;
    border-radius:10px;
    background:#fff;
    color:#4b2cff;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 8px 18px rgba(0,0,0,.18);
    height:36px;
  }
  .btn:active{ transform:translateY(1px); }

  .container{ padding:18px; max-width:1320px; margin:0 auto; }

  .tabs{ display:flex; gap:10px; margin:6px 0 14px; }
  .tab{
    padding:10px 14px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    cursor:pointer;
    font-weight:700;
    color:#344054;
    box-shadow:0 2px 8px rgba(16,24,40,.05);
  }
  .tab.active{
    background:#f0ecff;
    border-color:#d8ccff;
    color:#4b2cff;
  }

  .kpi-grid{
    display:grid;
    grid-template-columns:repeat(6, minmax(0,1fr));
    gap:12px;
    margin:6px 0 14px;
  }
  @media (max-width:1200px){ .kpi-grid{ grid-template-columns:repeat(3,minmax(0,1fr)); } }
  @media (max-width:680px){ .kpi-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); } }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
  }
  .kpi{
    padding:12px 12px 10px;
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height:92px;
  }
  .kpi .label{ font-size:11px; color:var(--muted); line-height:1.2; }
  .kpi .value{ font-size:22px; font-weight:800; letter-spacing:.2px; }
  .kpi .delta{ font-size:12px; color:#12b76a; font-weight:700; }
  .kpi .delta.neg{ color:#f04438; }

  .grid{
    display:grid;
    grid-template-columns:repeat(12, minmax(0,1fr));
    gap:12px;
  }
  .chart-card{ padding:12px; }
  .chart-title{ font-weight:800; font-size:13px; color:#344054; margin:0 0 8px; }
  .span-6{ grid-column:span 6; }
  .span-4{ grid-column:span 4; }
  .span-8{ grid-column:span 8; }
  .span-12{ grid-column:span 12; }
  @media (max-width:1100px){
    .span-6,.span-4,.span-8{ grid-column:span 12; }
  }
  canvas{ width:100% !important; height:300px !important; }

  .table-controls{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    margin:10px 0;
  }
  .table-controls .pill{
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    cursor:pointer;
    font-weight:800;
    color:#344054;
  }
  .table-controls .pill.active{
    background:#f0ecff;
    border-color:#d8ccff;
    color:#4b2cff;
  }
  .search{
    margin-left:auto;
    background:#fff;
    border:1px solid var(--line);
    border-radius:12px;
    padding:10px 12px;
    min-width:260px;
    outline:none;
  }

  .table-wrap{ overflow:auto; border-radius:var(--radius); }
  table{ width:100%; border-collapse:separate; border-spacing:0; min-width:1100px; }
  thead th{
    position:sticky; top:0;
    background:#fff;
    z-index:5;
    font-size:12px;
    color:#344054;
    text-align:left;
    padding:12px;
    border-bottom:1px solid var(--line);
    cursor:pointer;
    white-space:nowrap;
  }
  tbody td{
    padding:12px;
    border-bottom:1px solid var(--line);
    font-size:12px;
    color:#101828;
    white-space:nowrap;
  }
  tbody tr:hover td{ background:#fafbff; }
  tfoot td{
    padding:12px;
    font-weight:900;
    border-top:2px solid var(--line);
    background:#fcfcff;
    position:sticky; bottom:0;
  }
  .muted{ color:var(--muted); }
  .right{ text-align:right; }
</style>
</head>

<body>
<header>
  <div class="header-row">
    <div class="title-wrap">
      <h1>Перехват заказов на приемке</h1>
      <div class="subtitle">Кликабельный BI-прототип: фильтры → KPI/графики/таблица пересчитываются локально</div>
    </div>

    <div class="filters">
      <div class="filter">
        <label>Склад (multiselect)</label>
        <select id="whSelect" multiple size="3"></select>
      </div>
      <div class="filter">
        <label>Период (date range)</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <input id="dateFrom" type="date">
          <input id="dateTo" type="date">
        </div>
      </div>
      <button class="btn" id="refreshBtn">Обновить</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="tabs">
    <div class="tab active" data-tab="charts">Графики</div>
    <div class="tab" data-tab="table">Таблица</div>
  </div>

  <!-- KPI -->
  <div class="kpi-grid" id="kpiGrid"></div>

  <!-- CHARTS -->
  <div id="chartsView">
    <div class="grid">
      <div class="card chart-card span-6">
        <div class="chart-title">1. Повышение скорости отгрузки заказа (получение заказа - отгрузка на ПВЗ)</div>
        <canvas id="c_speed"></canvas>
      </div>

      <div class="card chart-card span-6">
        <div class="chart-title">2. Снижение кол-ва касаний -> снижение затрат на обработку одной шт</div>
        <canvas id="c_touches"></canvas>
      </div>

      <div class="card chart-card span-4">
        <div class="chart-title">3. % перехваченных заказов на приемке (от кол-ва заказов в рамках склада)</div>
        <canvas id="c_intRateOrders"></canvas>
      </div>

      <div class="card chart-card span-4">
        <div class="chart-title">3. % перехваченных заказов на приемке (от кол-ва товаров на приемке в рамках склада)</div>
        <canvas id="c_intRateUnits"></canvas>
      </div>

      <div class="card chart-card span-4">
        <div class="chart-title">5. % ошибочных перемещений в тару сортировки</div>
        <canvas id="c_sortErr"></canvas>
      </div>

      <div class="card chart-card span-8">
        <div class="chart-title">4. абсолютное кол-во перехваченных заказов в рамках складов / компании</div>
        <canvas id="c_intAbs"></canvas>
      </div>

      <div class="card chart-card span-4">
        <div class="chart-title">Операционный контекст: поток товаров на приемке (шт)</div>
        <canvas id="c_units"></canvas>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div id="tableView" style="display:none;">
    <div class="card" style="padding:12px;">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;">
        <div>
          <div style="font-weight:900;font-size:14px;">Детализация</div>
          <div class="muted" style="font-size:12px;margin-top:4px;">Сортировка по клику на заголовок. Sticky header + итоговая строка.</div>
        </div>

        <div class="table-controls">
          <button class="pill active" data-mode="warehouse">по складам</button>
          <button class="pill" data-mode="day">по периодам</button>
          <input class="search" id="tableSearch" placeholder="Поиск по складу/дате..." />
        </div>
      </div>

      <div class="table-wrap" style="margin-top:10px;">
        <table id="dataTable">
          <thead></thead>
          <tbody></tbody>
          <tfoot></tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Mock data generator (локально)
   ========================= */

const WAREHOUSES = [
  "DE-Berlin-01",
  "DE-Leipzig-02",
  "DE-Frankfurt-03",
  "DE-Munich-04",
  "PL-Poznan-01",
  "CZ-Prague-01"
];

const state = {
  raw: [],
  filtered: [],
  mode: "warehouse",
  sort: { key: null, dir: "desc" },
  charts: {}
};

function rand(min, max){ return Math.random()*(max-min)+min; }
function rint(min, max){ return Math.floor(rand(min, max+1)); }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

function fmtNum(n){ return n.toLocaleString("ru-RU"); }
function fmtPct(x){ return (x*100).toFixed(1) + "%"; }
function fmtHours(x){ return x.toFixed(1) + " ч"; }
function fmt1(x){ return x.toFixed(1); }

function dateKey(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }

function defaultDateRange(){
  const to = new Date();
  const from = addDays(to, -27);
  return { from: dateKey(from), to: dateKey(to) };
}

function setUpFilters(){
  const whSel = document.getElementById("whSelect");
  whSel.innerHTML = "";
  WAREHOUSES.forEach(w=>{
    const opt = document.createElement("option");
    opt.value = w; opt.textContent = w; opt.selected = true;
    whSel.appendChild(opt);
  });

  const {from, to} = defaultDateRange();
  document.getElementById("dateFrom").value = from;
  document.getElementById("dateTo").value = to;
}

function generateMockRows(){
  // генерируем дневные агрегаты по складам (реалистичные колебания)
  const {from, to} = getDateRange();
  const start = new Date(from);
  const end = new Date(to);

  const rows = [];
  for(let d = new Date(start); d <= end; d = addDays(d, 1)){
    const dow = d.getDay();
    const weekendFactor = (dow===0 || dow===6) ? 0.72 : 1.0;

    WAREHOUSES.forEach(wh=>{
      const whFactor =
        wh.includes("Berlin") ? 1.15 :
        wh.includes("Leipzig") ? 1.05 :
        wh.includes("Frankfurt") ? 1.10 :
        wh.includes("Munich") ? 0.90 :
        wh.includes("Poznan") ? 0.95 : 0.88;

      // базовый поток
      const orders = Math.round(rand(320, 780) * whFactor * weekendFactor);
      const unitsPerOrder = rand(1.10, 1.55);
      const units = Math.round(orders * unitsPerOrder);

      // перехват на приемке: доля + абсолют
      const interceptRateOrders = clamp(rand(0.018, 0.085) + (whFactor-1)*0.01, 0.01, 0.12);
      const interceptAbs = Math.round(orders * interceptRateOrders);

      // доля перехватов от товаров на приемке
      const interceptRateUnits = clamp(interceptRateOrders * rand(0.85, 1.20), 0.01, 0.14);

      // скорость отгрузки (часы) — хотим снижать; немного тренда
      const dayIndex = Math.round((d - start)/(24*3600*1000));
      const trend = -0.015 * dayIndex; // улучшение по времени
      const speedHours = clamp(rand(15.5, 26.5) + trend + (whFactor-1)*1.2, 10.5, 34);

      // касания на товар — хотим снижать
      const touches = clamp(rand(2.2, 4.1) + (whFactor-1)*0.25 + trend*0.3, 1.6, 5.2);

      // % ошибочных перемещений в тару сортировки — хотим снижать
      const sortErrRate = clamp(rand(0.002, 0.020) + (whFactor-1)*0.002 + (dow===1?0.001:0), 0.001, 0.03);

      rows.push({
        date: dateKey(d),
        warehouse: wh,

        orders,
        units,

        intercept_rate_orders: interceptRateOrders,
        intercept_rate_units: interceptRateUnits,
        intercept_abs: interceptAbs,

        speed_hours: speedHours,
        touches_per_unit: touches,

        sort_error_rate: sortErrRate
      });
    });
  }
  return rows;
}

function getSelectedWarehouses(){
  const sel = document.getElementById("whSelect");
  return Array.from(sel.selectedOptions).map(o=>o.value);
}
function getDateRange(){
  return {
    from: document.getElementById("dateFrom").value,
    to: document.getElementById("dateTo").value
  };
}

function applyFilters(){
  const whs = new Set(getSelectedWarehouses());
  const {from, to} = getDateRange();
  state.filtered = state.raw.filter(r => whs.has(r.warehouse) && r.date >= from && r.date <= to);
}

/* =========================
   Aggregations
   ========================= */
function groupBy(arr, keyFn){
  const m = new Map();
  for(const x of arr){
    const k = keyFn(x);
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(x);
  }
  return m;
}

function agg(rows){
  const sum = (k)=> rows.reduce((a,b)=>a + (b[k]||0), 0);
  const wavg = (valKey, weightKey)=>{
    const w = rows.reduce((a,b)=>a + (b[weightKey]||0), 0);
    if(w<=0) return 0;
    return rows.reduce((a,b)=>a + (b[valKey]||0)*(b[weightKey]||0), 0)/w;
  };

  const orders = sum("orders");
  const units  = sum("units");
  const interceptAbs = sum("intercept_abs");

  // ВАЖНО: доли — взвешенные по объему (orders/units)
  const interceptRateOrders = wavg("intercept_rate_orders","orders");
  const interceptRateUnits  = wavg("intercept_rate_units","units");

  const speedHours = wavg("speed_hours","orders"); // по заказам
  const touchesPerUnit = wavg("touches_per_unit","units"); // по товарам
  const sortErrRate = wavg("sort_error_rate","units"); // по товарам

  return {
    orders, units,
    interceptRateOrders, interceptRateUnits,
    interceptAbs,
    speedHours,
    touchesPerUnit,
    sortErrRate
  };
}

/* =========================
   KPI render (точные названия)
   ========================= */
function buildKpis(){
  const kpiGrid = document.getElementById("kpiGrid");
  const cur = agg(state.filtered);

  // для дельт: сравнение с предыдущим периодом той же длины
  const {from, to} = getDateRange();
  const start = new Date(from), end = new Date(to);
  const days = Math.round((end - start)/(24*3600*1000)) + 1;
  const prevTo = addDays(start, -1);
  const prevFrom = addDays(prevTo, -(days-1));

  const prev = state.raw.filter(r => {
    const dk = r.date;
    return dk >= dateKey(prevFrom) && dk <= dateKey(prevTo)
      && new Set(getSelectedWarehouses()).has(r.warehouse);
  });
  const prevAgg = agg(prev);

  function deltaPct(curr, prev){
    if(!isFinite(prev) || prev===0) return 0;
    return (curr - prev) / prev;
  }

  const cards = [
    {
      label: "1. Повышение скорости отгрузки заказа (получение заказа - отгрузка на ПВЗ)",
      value: fmtHours(cur.speedHours),
      delta: deltaPct(cur.speedHours, prevAgg.speedHours),
      goodIfDown: true
    },
    {
      label: "2. Снижение кол-ва касаний -> снижение затрат на обработку одной шт",
      value: fmt1(cur.touchesPerUnit),
      delta: deltaPct(cur.touchesPerUnit, prevAgg.touchesPerUnit),
      goodIfDown: true
    },
    {
      label: "3. % перехваченных заказов на приемке: от кол-ва заказов в рамках склада",
      value: fmtPct(cur.interceptRateOrders),
      delta: deltaPct(cur.interceptRateOrders, prevAgg.interceptRateOrders),
      goodIfDown: false
    },
    {
      label: "3. % перехваченных заказов на приемке: от кол-ва товаров на приемке в рамках склада",
      value: fmtPct(cur.interceptRateUnits),
      delta: deltaPct(cur.interceptRateUnits, prevAgg.interceptRateUnits),
      goodIfDown: false
    },
    {
      label: "4. абсолютное кол-во перехваченных заказов в рамках складов / компании",
      value: fmtNum(cur.interceptAbs),
      delta: deltaPct(cur.interceptAbs, prevAgg.interceptAbs),
      goodIfDown: false
    },
    {
      label: "5. % ошибочных перемещений в тару сортировки",
      value: fmtPct(cur.sortErrRate),
      delta: deltaPct(cur.sortErrRate, prevAgg.sortErrRate),
      goodIfDown: true
    }
  ];

  kpiGrid.innerHTML = "";
  cards.forEach(c=>{
    const d = document.createElement("div");
    d.className = "card kpi";
    const delta = c.delta;
    const isImprovement = c.goodIfDown ? (delta<0) : (delta>0);
    const deltaClass = isImprovement ? "delta" : "delta neg";
    const sign = delta>=0 ? "+" : "";
    d.innerHTML = `
      <div class="label">${c.label}</div>
      <div class="value">${c.value}</div>
      <div class="${deltaClass}">${sign}${(delta*100).toFixed(1)}% к предыдущему периоду</div>
    `;
    kpiGrid.appendChild(d);
  });
}

/* =========================
   Charts (Chart.js)
   ========================= */
function destroyChart(id){
  if(state.charts[id]){
    state.charts[id].destroy();
    delete state.charts[id];
  }
}

function buildCharts(){
  // агрегация по дням (компания)
  const byDay = groupBy(state.filtered, r=>r.date);
  const labels = Array.from(byDay.keys()).sort();

  const series = labels.map(day=>{
    const a = agg(byDay.get(day));
    return {
      day,
      speed: a.speedHours,
      touches: a.touchesPerUnit,
      intRateOrders: a.interceptRateOrders,
      intRateUnits: a.interceptRateUnits,
      intAbs: a.interceptAbs,
      sortErr: a.sortErrRate,
      units: a.units
    };
  });

  const mkLine = (canvasId, label, data, isPercent=false)=>{
    destroyChart(canvasId);
    const ctx = document.getElementById(canvasId);
    state.charts[canvasId] = new Chart(ctx, {
      type:"line",
      data:{
        labels,
        datasets:[{
          label,
          data,
          tension:0.25,
          fill:false,
          pointRadius:2.5
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ display:true } },
        scales:{
          y:{
            ticks:{
              callback:(v)=> isPercent ? (v*100).toFixed(0)+"%" : v
            }
          }
        }
      }
    });
  };

  const mkBar = (canvasId, label, data)=>{
    destroyChart(canvasId);
    const ctx = document.getElementById(canvasId);
    state.charts[canvasId] = new Chart(ctx, {
      type:"bar",
      data:{
        labels,
        datasets:[{ label, data }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ display:true } }
      }
    });
  };

  mkLine("c_speed",
    "Время, часы",
    series.map(s=>+s.speed.toFixed(2)),
    false
  );

  mkLine("c_touches",
    "Касания на товар",
    series.map(s=>+s.touches.toFixed(2)),
    false
  );

  mkLine("c_intRateOrders",
    "Доля от заказов",
    series.map(s=>+s.intRateOrders.toFixed(4)),
    true
  );

  mkLine("c_intRateUnits",
    "Доля от товаров",
    series.map(s=>+s.intRateUnits.toFixed(4)),
    true
  );

  mkLine("c_sortErr",
    "Ошибки перемещений",
    series.map(s=>+s.sortErr.toFixed(4)),
    true
  );

  mkBar("c_intAbs",
    "Перехвачено, заказов",
    series.map(s=>s.intAbs)
  );

  mkBar("c_units",
    "Товаров на приемке, шт",
    series.map(s=>s.units)
  );
}

/* =========================
   Table
   ========================= */
function buildTable(){
  const table = document.getElementById("dataTable");
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  const tfoot = table.querySelector("tfoot");

  let rows = [];
  if(state.mode==="warehouse"){
    const g = groupBy(state.filtered, r=>r.warehouse);
    rows = Array.from(g.entries()).map(([wh, items])=>{
      const a = agg(items);
      return {
        key: wh,
        "Склад": wh,
        "1. Повышение скорости отгрузки заказа (получение заказа - отгрузка на ПВЗ)": a.speedHours,
        "2. Снижение кол-ва касаний -> снижение затрат на обработку одной шт": a.touchesPerUnit,
        "3. % перехваченных заказов на приемке: от кол-ва заказов в рамках склада": a.interceptRateOrders,
        "3. % перехваченных заказов на приемке: от кол-ва товаров на приемке в рамках склада": a.interceptRateUnits,
        "4. абсолютное кол-во перехваченных заказов в рамках складов / компании": a.interceptAbs,
        "5. % ошибочных перемещений в тару сортировки": a.sortErrRate,
        "Заказы (шт)": a.orders,
        "Товары на приемке (шт)": a.units
      };
    });
  } else {
    const g = groupBy(state.filtered, r=>r.date);
    rows = Array.from(g.entries()).sort((a,b)=>a[0].localeCompare(b[0])).map(([day, items])=>{
      const a = agg(items);
      return {
        key: day,
        "Период": day,
        "1. Повышение скорости отгрузки заказа (получение заказа - отгрузка на ПВЗ)": a.speedHours,
        "2. Снижение кол-ва касаний -> снижение затрат на обработку одной шт": a.touchesPerUnit,
        "3. % перехваченных заказов на приемке: от кол-ва заказов в рамках склада": a.interceptRateOrders,
        "3. % перехваченных заказов на приемке: от кол-ва товаров на приемке в рамках склада": a.interceptRateUnits,
        "4. абсолютное кол-во перехваченных заказов в рамках складов / компании": a.interceptAbs,
        "5. % ошибочных перемещений в тару сортировки": a.sortErrRate,
        "Заказы (шт)": a.orders,
        "Товары на приемке (шт)": a.units
      };
    });
  }

  // search
  const q = (document.getElementById("tableSearch").value||"").trim().toLowerCase();
  if(q){
    rows = rows.filter(r=>{
      return Object.values(r).some(v=>String(v).toLowerCase().includes(q));
    });
  }

  // columns
  const dimCol = (state.mode==="warehouse") ? "Склад" : "Период";
  const cols = [
    dimCol,
    "Заказы (шт)",
    "Товары на приемке (шт)",
    "4. абсолютное кол-во перехваченных заказов в рамках складов / компании",
    "3. % перехваченных заказов на приемке: от кол-ва заказов в рамках склада",
    "3. % перехваченных заказов на приемке: от кол-ва товаров на приемке в рамках склада",
    "1. Повышение скорости отгрузки заказа (получение заказа - отгрузка на ПВЗ)",
    "2. Снижение кол-ва касаний -> снижение затрат на обработку одной шт",
    "5. % ошибочных перемещений в тару сортировки"
  ];

  // sort
  if(state.sort.key){
    const k = state.sort.key;
    const dir = state.sort.dir==="asc" ? 1 : -1;
    rows.sort((a,b)=>{
      const av = a[k], bv = b[k];
      if(typeof av === "number" && typeof bv === "number") return (av-bv)*dir;
      return String(av).localeCompare(String(bv))*dir;
    });
  }

  // head
  thead.innerHTML = "<tr>" + cols.map(c=>`<th data-col="${c}">${c}</th>`).join("") + "</tr>";

  // body
  tbody.innerHTML = rows.map(r=>{
    return "<tr>" + cols.map(c=>{
      const v = r[c];
      const isNum = typeof v === "number";
      let out = v;

      if(c.includes("% перехваченных") || c.includes("% ошибочных")){
        out = fmtPct(v);
      } else if(c.startsWith("1. ")){
        out = fmtHours(v);
      } else if(c.startsWith("2. ")){
        out = fmt1(v);
      } else if(isNum){
        out = fmtNum(Math.round(v));
      }
      const cls = isNum ? "right" : "";
      return `<td class="${cls}">${out}</td>`;
    }).join("") + "</tr>";
  }).join("");

  // footer totals (итого по отфильтрованным)
  const total = agg(state.filtered);
  const totalRow = {};
  totalRow[dimCol] = "Итого";
  totalRow["Заказы (шт)"] = total.orders;
  totalRow["Товары на приемке (шт)"] = total.units;
  totalRow["4. абсолютное кол-во перехваченных заказов в рамках складов / компании"] = total.interceptAbs;
  totalRow["3. % перехваченных заказов на приемке: от кол-ва заказов в рамках склада"] = total.interceptRateOrders;
  totalRow["3. % перехваченных заказов на приемке: от кол-ва товаров на приемке в рамках склада"] = total.interceptRateUnits;
  totalRow["1. Повышение скорости отгрузки заказа (получение заказа - отгрузка на ПВЗ)"] = total.speedHours;
  totalRow["2. Снижение кол-ва касаний -> снижение затрат на обработку одной шт"] = total.touchesPerUnit;
  totalRow["5. % ошибочных перемещений в тару сортировки"] = total.sortErrRate;

  tfoot.innerHTML = "<tr>" + cols.map(c=>{
    const v = totalRow[c];
    let out = v;

    if(c.includes("% перехваченных") || c.includes("% ошибочных")){
      out = fmtPct(v);
    } else if(c.startsWith("1. ")){
      out = fmtHours(v);
    } else if(c.startsWith("2. ")){
      out = fmt1(v);
    } else if(typeof v === "number"){
      out = fmtNum(Math.round(v));
    }
    const cls = (typeof v === "number") ? "right" : "";
    return `<td class="${cls}">${out}</td>`;
  }).join("") + "</tr>";

  // click sorting
  thead.querySelectorAll("th").forEach(th=>{
    th.onclick = ()=>{
      const col = th.dataset.col;
      if(state.sort.key===col){
        state.sort.dir = state.sort.dir==="asc" ? "desc" : "asc";
      } else {
        state.sort.key = col;
        state.sort.dir = "desc";
      }
      buildTable();
    };
  });
}

/* =========================
   UI wiring
   ========================= */
function setTab(tab){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
  document.getElementById("chartsView").style.display = (tab==="charts") ? "block" : "none";
  document.getElementById("tableView").style.display  = (tab==="table")  ? "block" : "none";
}

function setMode(mode){
  state.mode = mode;
  document.querySelectorAll(".pill").forEach(p=>p.classList.toggle("active", p.dataset.mode===mode));
  buildTable();
}

function refreshAll(regen=false){
  if(regen){
    state.raw = generateMockRows();
  }
  applyFilters();
  buildKpis();
  buildCharts();
  buildTable();
}

document.getElementById("refreshBtn").addEventListener("click", ()=> refreshAll(true));

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=> setTab(t.dataset.tab));
});

document.querySelectorAll(".pill").forEach(p=>{
  p.addEventListener("click", ()=> setMode(p.dataset.mode));
});

document.getElementById("tableSearch").addEventListener("input", ()=> buildTable());

/* =========================
   Init
   ========================= */
setUpFilters();
state.raw = generateMockRows();
refreshAll(false);
</script>
</body>
</html>

