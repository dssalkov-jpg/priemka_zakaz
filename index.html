<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ü–µ—Ä–µ—Ö–≤–∞—Ç –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:#e5e7eb;
    --purple:#7c3aed;
    --purple2:#8b5cf6;
    --purpleSoft:#f1eafe;
    --shadow:0 8px 24px rgba(17,24,39,.08);
    --radius:16px;
    --good:#12b76a;
    --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  header{
    background:linear-gradient(90deg, #8b5cf6, #7c3aed);
    color:#fff;
    position:sticky; top:0; z-index:50;
    box-shadow:0 10px 24px rgba(0,0,0,.18);
  }
  .topbar{
    max-width:1200px;
    margin:0 auto;
    padding:14px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .brand{
    width:34px;height:34px;border-radius:999px;
    background:rgba(255,255,255,.95);
    color:var(--purple);
    display:flex;align-items:center;justify-content:center;
    font-weight:900;
    box-shadow:0 6px 14px rgba(0,0,0,.18);
    flex:0 0 auto;
  }
  .title{
    font-weight:900;
    font-size:18px;
    letter-spacing:.2px;
    text-align:center;
    flex:1 1 auto;
  }
  .right-icons{
    display:flex;gap:10px;align-items:center;flex:0 0 auto;
    opacity:.95;
  }
  .badge{
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.35);
    background:rgba(255,255,255,.14);
    user-select:none;
  }
  .icon{
    width:34px;height:34px;border-radius:999px;
    border:1px solid rgba(255,255,255,.35);
    background:rgba(255,255,255,.14);
    display:flex;align-items:center;justify-content:center;
    font-weight:900;
    user-select:none;
  }

  .filtersbar{
    background:#fff;
    border-bottom:1px solid var(--line);
  }
  .filters{
    max-width:1200px;
    margin:0 auto;
    padding:14px 16px;
    display:flex;
    gap:14px;
    align-items:flex-end;
    flex-wrap:wrap;
  }
  .fgroup{ display:flex; flex-direction:column; gap:6px; }
  .flabel{
    font-size:12px;
    color:var(--muted);
    font-weight:700;
  }
  .control{
    display:flex;
    align-items:center;
    gap:8px;
    background:#fff;
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 2px 10px rgba(17,24,39,.04);
    min-height:44px;
  }
  .control .main{
    font-weight:800;
    color:#111827;
    white-space:nowrap;
  }
  .control .sub{
    font-size:12px;
    color:var(--muted);
    margin-top:2px;
    white-space:nowrap;
  }
  .control-col{ display:flex; flex-direction:column; line-height:1.1; }
  .control .caret{
    margin-left:8px;
    width:22px;height:22px;border-radius:999px;
    display:flex;align-items:center;justify-content:center;
    background:#f3f4f6;
    color:#111827;
    font-size:12px;
    flex:0 0 auto;
  }
  .control .clear{
    width:22px;height:22px;border-radius:999px;
    display:flex;align-items:center;justify-content:center;
    background:#f3f4f6;
    color:#6b7280;
    cursor:pointer;
    flex:0 0 auto;
  }
  .daterange{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  .range-pill{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:14px;
    background:#fff;
    box-shadow:0 2px 10px rgba(17,24,39,.04);
    min-height:44px;
  }
  .range-pill .range-title{
    display:flex; flex-direction:column; line-height:1.1;
  }
  .range-pill .range-title .main{ font-weight:900; }
  .range-pill .range-title .sub{ font-size:12px; color:var(--muted); margin-top:2px;}
  .range-pill input[type="date"]{
    border:none;
    outline:none;
    font-weight:800;
    color:#111827;
    background:transparent;
  }
  .btn{
    margin-left:auto;
    background:linear-gradient(90deg,#7c3aed,#8b5cf6);
    color:#fff;
    border:none;
    border-radius:999px;
    padding:12px 18px;
    font-weight:900;
    cursor:pointer;
    box-shadow:0 14px 28px rgba(124,58,237,.28);
    min-height:44px;
  }
  .btn:active{ transform:translateY(1px); }

  .dropdown{ position:relative; }
  .menu{
    position:absolute;
    top:52px; left:0;
    width:340px;
    max-height:340px;
    overflow:auto;
    background:#fff;
    border:1px solid var(--line);
    border-radius:14px;
    box-shadow:var(--shadow);
    display:none;
    z-index:60;
    padding:8px;
  }
  .menu.open{ display:block; }
  .menu .row{
    display:flex; align-items:center; gap:10px;
    padding:10px 10px;
    border-radius:12px;
    cursor:pointer;
  }
  .menu .row:hover{ background:#fafafa; }
  .menu input{ width:16px; height:16px; }
  .menu .row .name{ font-weight:800; }
  .menu .row .hint{ font-size:12px; color:var(--muted); margin-left:auto; }

  .container{ max-width:1200px; margin:0 auto; padding:18px 16px 26px; }

  .tabs{
    display:flex; gap:22px;
    align-items:flex-end;
    padding:10px 2px 0;
    margin-bottom:10px;
  }
  .tab{
    font-weight:900;
    color:#6b7280;
    cursor:pointer;
    padding:10px 4px;
    position:relative;
    user-select:none;
  }
  .tab.active{ color:#111827; }
  .tab.active:after{
    content:"";
    position:absolute;
    left:0; right:0; bottom:0;
    height:3px;
    border-radius:999px;
    background:var(--purple);
  }

  .kpi-grid{
    display:grid;
    grid-template-columns:repeat(3, minmax(0, 1fr));
    gap:14px;
    margin:12px 0 14px;
  }
  @media (max-width:900px){
    .kpi-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); }
    .btn{ margin-left:0; }
  }
  @media (max-width:560px){
    .kpi-grid{ grid-template-columns:1fr; }
  }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
  }
  .kpi{
    padding:14px 16px;
    min-height:84px;
    display:flex; flex-direction:column; gap:10px;
  }
  .kpi .klabel{ font-size:12px; color:var(--muted); font-weight:900; line-height:1.25; }
  .kpi .kvalue{ font-size:34px; font-weight:950; letter-spacing:.2px; }
  .kpi .kdelta{ font-size:14px; font-weight:950; color:var(--good); }

  .lane{ margin-top:12px; }
  .lane-title{
    margin:14px 0 12px;
    background:var(--purpleSoft);
    border:1px solid #e9ddff;
    color:var(--purple);
    font-weight:950;
    border-radius:14px;
    padding:12px 14px;
    text-align:center;
    letter-spacing:.2px;
  }

  .chart-card{ padding:14px 14px 12px; }
  .chart-title{
    font-weight:950;
    font-size:14px;
    margin:0 0 10px;
    color:#374151;
  }
  .chart-sub{
    margin:0 0 10px;
    font-size:12px;
    color:var(--muted);
    font-weight:800;
  }
  canvas{ width:100% !important; height:300px !important; }

  .table-wrap{ overflow:auto; border-radius:var(--radius); }
  table{ width:100%; border-collapse:separate; border-spacing:0; min-width:1150px; }
  thead th{
    position:sticky; top:0;
    background:#fff;
    z-index:5;
    font-size:12px;
    color:#374151;
    text-align:left;
    padding:12px;
    border-bottom:1px solid var(--line);
    cursor:pointer;
    white-space:nowrap;
    font-weight:950;
  }
  tbody td{
    padding:12px;
    border-bottom:1px solid var(--line);
    font-size:12px;
    white-space:nowrap;
  }
  tbody tr:hover td{ background:#fafafa; }
  tfoot td{
    padding:12px;
    font-weight:950;
    border-top:2px solid var(--line);
    background:#fcfcff;
    position:sticky; bottom:0;
  }
  .right{ text-align:right; }
  .table-controls{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    margin:10px 0 12px;
  }
  .pill{
    padding:8px 12px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    cursor:pointer;
    font-weight:950;
    color:#374151;
  }
  .pill.active{
    background:var(--purpleSoft);
    border-color:#e9ddff;
    color:var(--purple);
  }
  .search{
    margin-left:auto;
    background:#fff;
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px 12px;
    min-width:260px;
    outline:none;
    font-weight:800;
  }
</style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">wb</div>
    <div class="title">–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å—Ç–æ–ª—ã</div>
    <div class="right-icons">
      <div class="badge">v20.1.6</div>
      <div class="icon">?</div>
      <div class="icon">‚éò</div>
      <div class="icon">üîí</div>
    </div>
  </div>
</header>

<div class="filtersbar">
  <div class="filters">
    <div class="fgroup dropdown" style="min-width:340px;">
      <div class="flabel">–°–∫–ª–∞–¥ (–≤—ã–±—Ä–∞–Ω–æ: <span id="whCount">0</span>) *</div>
      <!-- clickable control to open dropdown -->
      <div class="control" id="whControl" style="cursor:pointer;">
        <div class="control-col">
          <div class="main" id="whMain">–í—ã–±—Ä–∞–Ω—ã –≤—Å–µ</div>
          <div class="sub">–ú—É–ª—å—Ç–∏–≤—ã–±–æ—Ä</div>
        </div>
        <div style="flex:1"></div>
        <div class="clear" id="whClear" title="–°–±—Ä–æ—Å">√ó</div>
        <div class="caret">‚ñæ</div>
      </div>
      <div class="menu" id="whMenu"></div>
    </div>

    <div class="fgroup" style="min-width:420px; flex:1 1 auto;">
      <div class="flabel">–ü–µ—Ä–∏–æ–¥ *</div>
      <div class="daterange">
        <div class="range-pill" style="flex:1 1 auto; min-width:320px;">
          <div class="range-title" style="flex:1">
            <div class="main" id="rangeLabel">‚Äî</div>
            <div class="sub">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç</div>
          </div>
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <input id="dateFrom" type="date">
            <div style="font-weight:900;color:#9ca3af;">‚Äî</div>
            <input id="dateTo" type="date">
          </div>
        </div>

        <button class="btn" id="refreshBtn">‚ü≥&nbsp; –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="tabs">
    <div class="tab active" data-tab="charts">–ì—Ä–∞—Ñ–∏–∫–∏</div>
    <div class="tab" data-tab="table">–¢–∞–±–ª–∏—Ü–∞</div>
  </div>

  <div class="kpi-grid" id="kpiGrid"></div>

  <div id="chartsView">
    <!-- Company -->
    <div class="lane">
      <div class="lane-title">–°–≤–æ–¥–Ω–∞—è –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º</div>

      <div class="card chart-card">
        <div class="chart-title">1‚Äì2. –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≥—Ä—É–∑–∫–∏ + –∫–∞—Å–∞–Ω–∏—è –Ω–∞ —Ç–æ–≤–∞—Ä</div>
        <div class="chart-sub">–î–≤–µ –ª–∏–Ω–∏–∏ (–ª–µ–≥–µ–Ω–¥–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞: —Å–∫—Ä—ã–≤–∞–µ—Ç/–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ—Ä–∏—é)</div>
        <canvas id="c_company_12"></canvas>
      </div>

      <div style="height:12px"></div>

      <div class="card chart-card">
        <div class="chart-title">3‚Äì4. % –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ (–æ—Ç –∑–∞–∫–∞–∑–æ–≤ / –æ—Ç —Ç–æ–≤–∞—Ä–æ–≤) + –∞–±—Å–æ–ª—é—Ç –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
        <div class="chart-sub">–¢—Ä–∏ —Å–µ—Ä–∏–∏ (–ª–µ–≥–µ–Ω–¥–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞: —Å–∫—Ä—ã–≤–∞–µ—Ç/–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ—Ä–∏—é)</div>
        <canvas id="c_company_34"></canvas>
      </div>

      <div style="height:12px"></div>

      <div class="card chart-card">
        <div class="chart-title">5. % –æ—à–∏–±–æ—á–Ω—ã—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π + –ø–æ—Ç–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ (—à—Ç)</div>
        <div class="chart-sub">–î–≤–µ —Å–µ—Ä–∏–∏ (–ª–µ–≥–µ–Ω–¥–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞: —Å–∫—Ä—ã–≤–∞–µ—Ç/–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ—Ä–∏—é)</div>
        <canvas id="c_company_5u"></canvas>
      </div>
    </div>

    <!-- Koledino -->
    <div class="lane">
      <div class="lane-title">–ö–æ–ª–µ–¥–∏–Ω–æ</div>

      <div class="card chart-card">
        <div class="chart-title">1‚Äì2. –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≥—Ä—É–∑–∫–∏ + –∫–∞—Å–∞–Ω–∏—è –Ω–∞ —Ç–æ–≤–∞—Ä</div>
        <div class="chart-sub">–î–≤–µ –ª–∏–Ω–∏–∏ (–ª–µ–≥–µ–Ω–¥–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞: —Å–∫—Ä—ã–≤–∞–µ—Ç/–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ—Ä–∏—é)</div>
        <canvas id="c_koledino_12"></canvas>
      </div>

      <div style="height:12px"></div>

      <div class="card chart-card">
        <div class="chart-title">3‚Äì4. % –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ (–æ—Ç –∑–∞–∫–∞–∑–æ–≤ / –æ—Ç —Ç–æ–≤–∞—Ä–æ–≤) + –∞–±—Å–æ–ª—é—Ç –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
        <div class="chart-sub">–¢—Ä–∏ —Å–µ—Ä–∏–∏ (–ª–µ–≥–µ–Ω–¥–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞: —Å–∫—Ä—ã–≤–∞–µ—Ç/–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ—Ä–∏—é)</div>
        <canvas id="c_koledino_34"></canvas>
      </div>

      <div style="height:12px"></div>

      <div class="card chart-card">
        <div class="chart-title">5. % –æ—à–∏–±–æ—á–Ω—ã—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π + –ø–æ—Ç–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ (—à—Ç)</div>
        <div class="chart-sub">–î–≤–µ —Å–µ—Ä–∏–∏ (–ª–µ–≥–µ–Ω–¥–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞: —Å–∫—Ä—ã–≤–∞–µ—Ç/–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ—Ä–∏—é)</div>
        <canvas id="c_koledino_5u"></canvas>
      </div>
    </div>

    <!-- Kazan -->
    <div class="lane">
      <div class="lane-title">–ö–∞–∑–∞–Ω—å</div>

      <div class="card chart-card">
        <div class="chart-title">1‚Äì2. –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–≥—Ä—É–∑–∫–∏ + –∫–∞—Å–∞–Ω–∏—è –Ω–∞ —Ç–æ–≤–∞—Ä</div>
        <div class="chart-sub">–î–≤–µ –ª–∏–Ω–∏–∏ (–ª–µ–≥–µ–Ω–¥–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞: —Å–∫—Ä—ã–≤–∞–µ—Ç/–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ—Ä–∏—é)</div>
        <canvas id="c_kazan_12"></canvas>
      </div>

      <div style="height:12px"></div>

      <div class="card chart-card">
        <div class="chart-title">3‚Äì4. % –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ (–æ—Ç –∑–∞–∫–∞–∑–æ–≤ / –æ—Ç —Ç–æ–≤–∞—Ä–æ–≤) + –∞–±—Å–æ–ª—é—Ç –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
        <div class="chart-sub">–¢—Ä–∏ —Å–µ—Ä–∏–∏ (–ª–µ–≥–µ–Ω–¥–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞: —Å–∫—Ä—ã–≤–∞–µ—Ç/–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ—Ä–∏—é)</div>
        <canvas id="c_kazan_34"></canvas>
      </div>

      <div style="height:12px"></div>

      <div class="card chart-card">
        <div class="chart-title">5. % –æ—à–∏–±–æ—á–Ω—ã—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π + –ø–æ—Ç–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ (—à—Ç)</div>
        <div class="chart-sub">–î–≤–µ —Å–µ—Ä–∏–∏ (–ª–µ–≥–µ–Ω–¥–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞: —Å–∫—Ä—ã–≤–∞–µ—Ç/–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ—Ä–∏—é)</div>
        <canvas id="c_kazan_5u"></canvas>
      </div>
    </div>
  </div>

  <div id="tableView" style="display:none;">
    <div class="card" style="padding:14px;">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;">
        <div>
          <div style="font-weight:950;font-size:14px;">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è</div>
          <div style="font-size:12px;color:var(--muted);font-weight:700;margin-top:4px;">
            –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫. Sticky header + –∏—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞.
          </div>
        </div>

        <div class="table-controls">
          <button class="pill active" data-mode="warehouse">–ø–æ —Å–∫–ª–∞–¥–∞–º</button>
          <button class="pill" data-mode="day">–ø–æ –ø–µ—Ä–∏–æ–¥–∞–º</button>
          <input class="search" id="tableSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–∫–ª–∞–¥—É/–¥–∞—Ç–µ..." />
        </div>
      </div>

      <div class="table-wrap" style="margin-top:10px;">
        <table id="dataTable">
          <thead></thead>
          <tbody></tbody>
          <tfoot></tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Warehouses (expanded with cities examples)
   ========================= */
const WAREHOUSES = [
  "–ö–æ–ª–µ–¥–∏–Ω–æ",
  "–ö–∞–∑–∞–Ω—å",
  "–ß–µ–ª—è–±–∏–Ω—Å–∫",
  "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥",
  "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫",
  "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä",
  "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
  "–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É",
  "–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥",
  "–°–∞–º–∞—Ä–∞",
  "–¢—É–ª–∞",
  "–í–æ—Ä–æ–Ω–µ–∂",
  "–£—Ñ–∞",
  "–ü–µ—Ä–º—å",
  "–û–º—Å–∫",
  "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫"
];

const state = {
  raw: [],
  filtered: [],
  mode: "warehouse",
  sort: { key: null, dir: "desc" },
  charts: {},
  selectedWarehouses: new Set(),
  kpiDeltaPct: {}
};

function rand(min, max){ return Math.random()*(max-min)+min; }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function fmtNum(n){ return n.toLocaleString("ru-RU"); }
function fmtPct(x){ return (x*100).toFixed(1) + "%"; }
function fmtHours(x){ return x.toFixed(1) + " —á"; }
function fmt1(x){ return x.toFixed(1); }

function dateKey(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }

function prettyRuDate(iso){
  const d = new Date(iso + "T00:00:00");
  const months = ["—è–Ω–≤–∞—Ä—è","—Ñ–µ–≤—Ä–∞–ª—è","–º–∞—Ä—Ç–∞","–∞–ø—Ä–µ–ª—è","–º–∞—è","–∏—é–Ω—è","–∏—é–ª—è","–∞–≤–≥—É—Å—Ç–∞","—Å–µ–Ω—Ç—è–±—Ä—è","–æ–∫—Ç—è–±—Ä—è","–Ω–æ—è–±—Ä—è","–¥–µ–∫–∞–±—Ä—è"];
  return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()} –≥.`;
}

function defaultDateRange(){
  const to = new Date();
  const from = addDays(to, -27);
  return { from: dateKey(from), to: dateKey(to) };
}
function getDateRange(){
  return {
    from: document.getElementById("dateFrom").value,
    to: document.getElementById("dateTo").value
  };
}
function updateRangeLabel(){
  const {from,to} = getDateRange();
  document.getElementById("rangeLabel").textContent = `${prettyRuDate(from)} ‚Äî ${prettyRuDate(to)}`;
}

/* ===== Custom multiselect (openable dropdown) ===== */
function buildWarehouseMenu(){
  const menu = document.getElementById("whMenu");
  menu.innerHTML = "";

  const mkRow = (name, checked, hint, onToggle)=>{
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <input type="checkbox" ${checked ? "checked" : ""} />
      <div class="name">${name}</div>
      <div class="hint">${hint || ""}</div>
    `;
    const cb = row.querySelector("input");
    row.addEventListener("click", (e)=>{
      if(e.target.tagName !== "INPUT") cb.checked = !cb.checked;
      onToggle(cb.checked);
      e.stopPropagation();
    });
    cb.addEventListener("click",(e)=> e.stopPropagation());
    return row;
  };

  const allChecked = state.selectedWarehouses.size === WAREHOUSES.length;
  menu.appendChild(mkRow("–í—ã–±—Ä–∞—Ç—å –≤—Å–µ", allChecked, "", (isOn)=>{
    state.selectedWarehouses = isOn ? new Set(WAREHOUSES) : new Set();
    buildWarehouseMenu();
    updateWarehouseControl();
  }));

  const hr = document.createElement("div");
  hr.style.height="1px";
  hr.style.background="var(--line)";
  hr.style.margin="8px 0";
  menu.appendChild(hr);

  WAREHOUSES.forEach(w=>{
    const checked = state.selectedWarehouses.has(w);
    menu.appendChild(mkRow(w, checked, "", (isOn)=>{
      if(isOn) state.selectedWarehouses.add(w);
      else state.selectedWarehouses.delete(w);
      buildWarehouseMenu();
      updateWarehouseControl();
    }));
  });
}

function updateWarehouseControl(){
  const cnt = state.selectedWarehouses.size;
  document.getElementById("whCount").textContent = cnt;
  const main = document.getElementById("whMain");
  if(cnt === 0) main.textContent = "–ù–µ –≤—ã–±—Ä–∞–Ω–æ";
  else if(cnt === WAREHOUSES.length) main.textContent = "–í—ã–±—Ä–∞–Ω—ã –≤—Å–µ";
  else main.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${cnt}`;
}

function toggleWarehouseMenu(force){
  const menu = document.getElementById("whMenu");
  const open = (typeof force === "boolean") ? force : !menu.classList.contains("open");
  menu.classList.toggle("open", open);
}

/* ===== Data ===== */
function generateMockRows(){
  const {from, to} = getDateRange();
  const start = new Date(from);
  const end = new Date(to);

  const rows = [];
  for(let d = new Date(start); d <= end; d = addDays(d, 1)){
    const dow = d.getDay();
    const weekendFactor = (dow===0 || dow===6) ? 0.72 : 1.0;

    WAREHOUSES.forEach(wh=>{
      // per-warehouse factor so Koledino/Kazan look different too
      const whFactor =
        wh === "–ö–æ–ª–µ–¥–∏–Ω–æ" ? 1.25 :
        wh === "–ö–∞–∑–∞–Ω—å" ? 1.05 :
        wh === "–ß–µ–ª—è–±–∏–Ω—Å–∫" ? 0.95 :
        wh === "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥" ? 1.10 :
        wh === "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫" ? 0.92 :
        0.90 + (Math.abs(hashCode(wh)) % 20)/100; // 0.90..1.10

      const orders = Math.round(rand(320, 780) * whFactor * weekendFactor);
      const unitsPerOrder = rand(1.10, 1.55);
      const units = Math.round(orders * unitsPerOrder);

      const interceptRateOrders = clamp(rand(0.018, 0.085) + (whFactor-1)*0.012, 0.01, 0.14);
      const interceptAbs = Math.round(orders * interceptRateOrders);
      const interceptRateUnits = clamp(interceptRateOrders * rand(0.85, 1.20), 0.01, 0.16);

      const dayIndex = Math.round((d - start)/(24*3600*1000));
      const trend = -0.015 * dayIndex;
      const speedHours = clamp(rand(15.5, 26.5) + trend + (whFactor-1)*1.4, 10.5, 36);

      const touches = clamp(rand(2.2, 4.1) + (whFactor-1)*0.28 + trend*0.3, 1.6, 5.4);

      const sortErrRate = clamp(rand(0.002, 0.020) + (whFactor-1)*0.002 + (dow===1?0.001:0), 0.001, 0.03);

      rows.push({
        date: dateKey(d),
        warehouse: wh,
        orders,
        units,
        intercept_rate_orders: interceptRateOrders,
        intercept_rate_units: interceptRateUnits,
        intercept_abs: interceptAbs,
        speed_hours: speedHours,
        touches_per_unit: touches,
        sort_error_rate: sortErrRate
      });
    });
  }
  return rows;
}

function hashCode(str){
  let h = 0;
  for(let i=0;i<str.length;i++){
    h = ((h<<5) - h) + str.charCodeAt(i);
    h |= 0;
  }
  return h;
}

function applyFilters(){
  const {from, to} = getDateRange();
  state.filtered = state.raw.filter(r =>
    state.selectedWarehouses.has(r.warehouse) &&
    r.date >= from && r.date <= to
  );
}

function groupBy(arr, keyFn){
  const m = new Map();
  for(const x of arr){
    const k = keyFn(x);
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(x);
  }
  return m;
}

function agg(rows){
  const sum = (k)=> rows.reduce((a,b)=>a + (b[k]||0), 0);
  const wavg = (valKey, weightKey)=>{
    const w = rows.reduce((a,b)=>a + (b[weightKey]||0), 0);
    if(w<=0) return 0;
    return rows.reduce((a,b)=>a + (b[valKey]||0)*(b[weightKey]||0), 0)/w;
  };

  const orders = sum("orders");
  const units  = sum("units");
  const interceptAbs = sum("intercept_abs");

  const interceptRateOrders = wavg("intercept_rate_orders","orders");
  const interceptRateUnits  = wavg("intercept_rate_units","units");

  const speedHours = wavg("speed_hours","orders");
  const touchesPerUnit = wavg("touches_per_unit","units");
  const sortErrRate = wavg("sort_error_rate","units");

  return { orders, units, interceptAbs, interceptRateOrders, interceptRateUnits, speedHours, touchesPerUnit, sortErrRate };
}

/* ===== KPI deltas: positive 5%..30% ===== */
function ensureKpiDeltas(){
  const keys = [
    "1. –ü–æ–≤—ã—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞ (–ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - –æ—Ç–≥—Ä—É–∑–∫–∞ –Ω–∞ –ü–í–ó)",
    "2. –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª-–≤–∞ –∫–∞—Å–∞–Ω–∏–π -> —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–¥–Ω–æ–π —à—Ç",
    "3. % –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ: 3.1. –æ—Ç –∫–æ–ª-–≤–∞ –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–∞",
    "3. % –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ: 3.2. –æ—Ç –∫–æ–ª-–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–∞",
    "4. –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–æ–≤ / –∫–æ–º–ø–∞–Ω–∏–∏",
    "5. % –æ—à–∏–±–æ—á–Ω—ã—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –≤ —Ç–∞—Ä—É —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏"
  ];
  keys.forEach(k=>{
    if(state.kpiDeltaPct[k] == null){
      state.kpiDeltaPct[k] = rand(0.05, 0.30);
    }
  });
}

function buildKpis(){
  ensureKpiDeltas();
  const kpiGrid = document.getElementById("kpiGrid");
  const cur = agg(state.filtered);

  const cards = [
    { label:"1. –ü–æ–≤—ã—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞ (–ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - –æ—Ç–≥—Ä—É–∑–∫–∞ –Ω–∞ –ü–í–ó)", value: fmtHours(cur.speedHours) },
    { label:"2. –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª-–≤–∞ –∫–∞—Å–∞–Ω–∏–π -> —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–¥–Ω–æ–π —à—Ç", value: fmt1(cur.touchesPerUnit) },
    { label:"3. % –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ: 3.1. –æ—Ç –∫–æ–ª-–≤–∞ –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–∞", value: fmtPct(cur.interceptRateOrders) },
    { label:"3. % –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ: 3.2. –æ—Ç –∫–æ–ª-–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–∞", value: fmtPct(cur.interceptRateUnits) },
    { label:"4. –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–æ–≤ / –∫–æ–º–ø–∞–Ω–∏–∏", value: fmtNum(cur.interceptAbs) },
    { label:"5. % –æ—à–∏–±–æ—á–Ω—ã—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –≤ —Ç–∞—Ä—É —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏", value: fmtPct(cur.sortErrRate) }
  ];

  kpiGrid.innerHTML = "";
  cards.forEach(c=>{
    const delta = state.kpiDeltaPct[c.label] ?? 0.12;
    const d = document.createElement("div");
    d.className = "card kpi";
    d.innerHTML = `
      <div class="klabel">${c.label}</div>
      <div class="kvalue">${c.value}</div>
      <div class="kdelta">+${(delta*100).toFixed(1)}% –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –ø–µ—Ä–∏–æ–¥—É</div>
    `;
    kpiGrid.appendChild(d);
  });
}

/* ===== Charts ===== */
function destroyChart(id){
  if(state.charts[id]){
    state.charts[id].destroy();
    delete state.charts[id];
  }
}

const COLORS = ["#2563eb","#7c3aed","#10b981","#f59e0b","#ef4444","#06b6d4"];

function buildCombinedChartsForScope(scopeKey, canvas12, canvas34, canvas5u){
  // scopeKey: "company" | "–ö–æ–ª–µ–¥–∏–Ω–æ" | "–ö–∞–∑–∞–Ω—å"
  let scopedRows = [];
  if(scopeKey === "company"){
    scopedRows = state.filtered;
  } else {
    scopedRows = state.filtered.filter(r => r.warehouse === scopeKey);
  }

  const byDay = groupBy(scopedRows, r=>r.date);
  const labels = Array.from(byDay.keys()).sort();

  const series = labels.map(day=>{
    const a = agg(byDay.get(day));
    return {
      speed: a.speedHours,
      touches: a.touchesPerUnit,
      intRateOrders: a.interceptRateOrders,
      intRateUnits: a.interceptRateUnits,
      intAbs: a.interceptAbs,
      sortErr: a.sortErrRate,
      units: a.units
    };
  });

  const baseOptions = {
    responsive:true,
    maintainAspectRatio:false,
    interaction:{ mode:"index", intersect:false },
    plugins:{
      legend:{
        display:true,
        labels:{ boxWidth:18, boxHeight:10, font:{ weight:"700" } }
        // Chart.js: legend click toggles dataset visibility by default
      },
      tooltip:{ enabled:true }
    },
    scales:{
      x:{ ticks:{ maxRotation:45, minRotation:45 } }
    }
  };

  // 1+2
  destroyChart(canvas12);
  state.charts[canvas12] = new Chart(document.getElementById(canvas12), {
    type:"line",
    data:{
      labels,
      datasets:[
        {
          label:"1. –í—Ä–µ–º—è, —á–∞—Å—ã",
          data: series.map(s=>+s.speed.toFixed(2)),
          borderColor: COLORS[0],
          backgroundColor: COLORS[0],
          tension:0.25,
          pointRadius:2.2,
          yAxisID:"y"
        },
        {
          label:"2. –ö–∞—Å–∞–Ω–∏—è –Ω–∞ —Ç–æ–≤–∞—Ä",
          data: series.map(s=>+s.touches.toFixed(2)),
          borderColor: COLORS[1],
          backgroundColor: COLORS[1],
          tension:0.25,
          pointRadius:2.2,
          yAxisID:"y1"
        }
      ]
    },
    options:{
      ...baseOptions,
      scales:{
        x: baseOptions.scales.x,
        y:{ position:"left", title:{ display:true, text:"–ß–∞—Å—ã" } },
        y1:{ position:"right", grid:{ drawOnChartArea:false }, title:{ display:true, text:"–ö–∞—Å–∞–Ω–∏—è" } }
      }
    }
  });

  // 3.1 + 3.2 + 4
  destroyChart(canvas34);
  state.charts[canvas34] = new Chart(document.getElementById(canvas34), {
    data:{
      labels,
      datasets:[
        {
          type:"line",
          label:"3.1 –î–æ–ª—è –æ—Ç –∑–∞–∫–∞–∑–æ–≤",
          data: series.map(s=>+s.intRateOrders.toFixed(4)),
          borderColor: COLORS[2],
          backgroundColor: COLORS[2],
          tension:0.25,
          pointRadius:2.2,
          yAxisID:"y"
        },
        {
          type:"line",
          label:"3.2 –î–æ–ª—è –æ—Ç —Ç–æ–≤–∞—Ä–æ–≤",
          data: series.map(s=>+s.intRateUnits.toFixed(4)),
          borderColor: COLORS[3],
          backgroundColor: COLORS[3],
          tension:0.25,
          pointRadius:2.2,
          yAxisID:"y"
        },
        {
          type:"bar",
          label:"4. –ü–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–æ, –∑–∞–∫–∞–∑–æ–≤",
          data: series.map(s=>s.intAbs),
          borderColor: COLORS[0],
          backgroundColor: "rgba(37, 99, 235, 0.18)",
          yAxisID:"y1"
        }
      ]
    },
    options:{
      ...baseOptions,
      scales:{
        x: baseOptions.scales.x,
        y:{
          position:"left",
          ticks:{ callback:(v)=> (v*100).toFixed(0)+"%" },
          title:{ display:true, text:"%" }
        },
        y1:{
          position:"right",
          grid:{ drawOnChartArea:false },
          title:{ display:true, text:"–ó–∞–∫–∞–∑—ã" }
        }
      }
    }
  });

  // 5 + units
  destroyChart(canvas5u);
  state.charts[canvas5u] = new Chart(document.getElementById(canvas5u), {
    data:{
      labels,
      datasets:[
        {
          type:"line",
          label:"5. –û—à–∏–±–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π",
          data: series.map(s=>+s.sortErr.toFixed(4)),
          borderColor: COLORS[4],
          backgroundColor: COLORS[4],
          tension:0.25,
          pointRadius:2.2,
          yAxisID:"y"
        },
        {
          type:"bar",
          label:"–ü–æ—Ç–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ, —à—Ç",
          data: series.map(s=>s.units),
          borderColor: COLORS[5],
          backgroundColor: "rgba(6, 182, 212, 0.20)",
          yAxisID:"y1"
        }
      ]
    },
    options:{
      ...baseOptions,
      scales:{
        x: baseOptions.scales.x,
        y:{
          position:"left",
          ticks:{ callback:(v)=> (v*100).toFixed(0)+"%" },
          title:{ display:true, text:"%" }
        },
        y1:{
          position:"right",
          grid:{ drawOnChartArea:false },
          title:{ display:true, text:"–®—Ç" }
        }
      }
    }
  });
}

function buildCharts(){
  // company (filtered)
  buildCombinedChartsForScope("company", "c_company_12", "c_company_34", "c_company_5u");
  // Koledino
  buildCombinedChartsForScope("–ö–æ–ª–µ–¥–∏–Ω–æ", "c_koledino_12", "c_koledino_34", "c_koledino_5u");
  // Kazan
  buildCombinedChartsForScope("–ö–∞–∑–∞–Ω—å", "c_kazan_12", "c_kazan_34", "c_kazan_5u");
}

/* ===== Table ===== */
function buildTable(){
  const table = document.getElementById("dataTable");
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  const tfoot = table.querySelector("tfoot");

  let rows = [];
  if(state.mode==="warehouse"){
    const g = groupBy(state.filtered, r=>r.warehouse);
    rows = Array.from(g.entries()).map(([wh, items])=>{
      const a = agg(items);
      return {
        key: wh,
        "–°–∫–ª–∞–¥": wh,
        "–ó–∞–∫–∞–∑—ã (—à—Ç)": a.orders,
        "–¢–æ–≤–∞—Ä—ã –Ω–∞ –ø—Ä–∏–µ–º–∫–µ (—à—Ç)": a.units,
        "4. –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–æ–≤ / –∫–æ–º–ø–∞–Ω–∏–∏": a.interceptAbs,
        "3. % –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ: 3.1. –æ—Ç –∫–æ–ª-–≤–∞ –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–∞": a.interceptRateOrders,
        "3. % –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ: 3.2. –æ—Ç –∫–æ–ª-–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–∞": a.interceptRateUnits,
        "1. –ü–æ–≤—ã—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞ (–ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - –æ—Ç–≥—Ä—É–∑–∫–∞ –Ω–∞ –ü–í–ó)": a.speedHours,
        "2. –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª-–≤–∞ –∫–∞—Å–∞–Ω–∏–π -> —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–¥–Ω–æ–π —à—Ç": a.touchesPerUnit,
        "5. % –æ—à–∏–±–æ—á–Ω—ã—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –≤ —Ç–∞—Ä—É —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏": a.sortErrRate
      };
    });
  } else {
    const g = groupBy(state.filtered, r=>r.date);
    rows = Array.from(g.entries()).sort((a,b)=>a[0].localeCompare(b[0])).map(([day, items])=>{
      const a = agg(items);
      return {
        key: day,
        "–ü–µ—Ä–∏–æ–¥": day,
        "–ó–∞–∫–∞–∑—ã (—à—Ç)": a.orders,
        "–¢–æ–≤–∞—Ä—ã –Ω–∞ –ø—Ä–∏–µ–º–∫–µ (—à—Ç)": a.units,
        "4. –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–æ–≤ / –∫–æ–º–ø–∞–Ω–∏–∏": a.interceptAbs,
        "3. % –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ: 3.1. –æ—Ç –∫–æ–ª-–≤–∞ –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–∞": a.interceptRateOrders,
        "3. % –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ: 3.2. –æ—Ç –∫–æ–ª-–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–∞": a.interceptRateUnits,
        "1. –ü–æ–≤—ã—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞ (–ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - –æ—Ç–≥—Ä—É–∑–∫–∞ –Ω–∞ –ü–í–ó)": a.speedHours,
        "2. –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª-–≤–∞ –∫–∞—Å–∞–Ω–∏–π -> —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–¥–Ω–æ–π —à—Ç": a.touchesPerUnit,
        "5. % –æ—à–∏–±–æ—á–Ω—ã—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –≤ —Ç–∞—Ä—É —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏": a.sortErrRate
      };
    });
  }

  const q = (document.getElementById("tableSearch").value||"").trim().toLowerCase();
  if(q){
    rows = rows.filter(r => Object.values(r).some(v=>String(v).toLowerCase().includes(q)));
  }

  const dimCol = (state.mode==="warehouse") ? "–°–∫–ª–∞–¥" : "–ü–µ—Ä–∏–æ–¥";
  const cols = [
    dimCol,
    "–ó–∞–∫–∞–∑—ã (—à—Ç)",
    "–¢–æ–≤–∞—Ä—ã –Ω–∞ –ø—Ä–∏–µ–º–∫–µ (—à—Ç)",
    "4. –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–æ–≤ / –∫–æ–º–ø–∞–Ω–∏–∏",
    "3. % –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ: 3.1. –æ—Ç –∫–æ–ª-–≤–∞ –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–∞",
    "3. % –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ: 3.2. –æ—Ç –∫–æ–ª-–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–∞",
    "1. –ü–æ–≤—ã—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞ (–ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - –æ—Ç–≥—Ä—É–∑–∫–∞ –Ω–∞ –ü–í–ó)",
    "2. –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª-–≤–∞ –∫–∞—Å–∞–Ω–∏–π -> —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–¥–Ω–æ–π —à—Ç",
    "5. % –æ—à–∏–±–æ—á–Ω—ã—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –≤ —Ç–∞—Ä—É —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏"
  ];

  if(state.sort.key){
    const k = state.sort.key;
    const dir = state.sort.dir==="asc" ? 1 : -1;
    rows.sort((a,b)=>{
      const av = a[k], bv = b[k];
      if(typeof av === "number" && typeof bv === "number") return (av-bv)*dir;
      return String(av).localeCompare(String(bv))*dir;
    });
  }

  thead.innerHTML = "<tr>" + cols.map(c=>`<th data-col="${c}">${c}</th>`).join("") + "</tr>";

  tbody.innerHTML = rows.map(r=>{
    return "<tr>" + cols.map(c=>{
      const v = r[c];
      const isNum = typeof v === "number";
      let out = v;

      if(c.startsWith("3. %") || c.startsWith("5. %")) out = fmtPct(v);
      else if(c.startsWith("1. ")) out = fmtHours(v);
      else if(c.startsWith("2. ")) out = fmt1(v);
      else if(isNum) out = fmtNum(Math.round(v));

      return `<td class="${isNum ? "right" : ""}">${out}</td>`;
    }).join("") + "</tr>";
  }).join("");

  const total = agg(state.filtered);
  const totalRow = {};
  totalRow[dimCol] = "–ò—Ç–æ–≥–æ";
  totalRow["–ó–∞–∫–∞–∑—ã (—à—Ç)"] = total.orders;
  totalRow["–¢–æ–≤–∞—Ä—ã –Ω–∞ –ø—Ä–∏–µ–º–∫–µ (—à—Ç)"] = total.units;
  totalRow["4. –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∫–æ–ª-–≤–æ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–æ–≤ / –∫–æ–º–ø–∞–Ω–∏–∏"] = total.interceptAbs;
  totalRow["3. % –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ: 3.1. –æ—Ç –∫–æ–ª-–≤–∞ –∑–∞–∫–∞–∑–æ–≤ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–∞"] = total.interceptRateOrders;
  totalRow["3. % –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ: 3.2. –æ—Ç –∫–æ–ª-–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –ø—Ä–∏–µ–º–∫–µ –≤ —Ä–∞–º–∫–∞—Ö —Å–∫–ª–∞–¥–∞"] = total.interceptRateUnits;
  totalRow["1. –ü–æ–≤—ã—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–∞ (–ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - –æ—Ç–≥—Ä—É–∑–∫–∞ –Ω–∞ –ü–í–ó)"] = total.speedHours;
  totalRow["2. –°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª-–≤–∞ –∫–∞—Å–∞–Ω–∏–π -> —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ–¥–Ω–æ–π —à—Ç"] = total.touchesPerUnit;
  totalRow["5. % –æ—à–∏–±–æ—á–Ω—ã—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –≤ —Ç–∞—Ä—É —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏"] = total.sortErrRate;

  tfoot.innerHTML = "<tr>" + cols.map(c=>{
    const v = totalRow[c];
    let out = v;
    if(c.startsWith("3. %") || c.startsWith("5. %")) out = fmtPct(v);
    else if(c.startsWith("1. ")) out = fmtHours(v);
    else if(c.startsWith("2. ")) out = fmt1(v);
    else if(typeof v === "number") out = fmtNum(Math.round(v));
    return `<td class="${typeof v === "number" ? "right" : ""}">${out}</td>`;
  }).join("") + "</tr>";

  thead.querySelectorAll("th").forEach(th=>{
    th.onclick = ()=>{
      const col = th.dataset.col;
      if(state.sort.key===col){
        state.sort.dir = state.sort.dir==="asc" ? "desc" : "asc";
      } else {
        state.sort.key = col;
        state.sort.dir = "desc";
      }
      buildTable();
    };
  });
}

/* ===== UI ===== */
function setTab(tab){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
  document.getElementById("chartsView").style.display = (tab==="charts") ? "block" : "none";
  document.getElementById("tableView").style.display  = (tab==="table")  ? "block" : "none";
}
function setMode(mode){
  state.mode = mode;
  document.querySelectorAll(".pill").forEach(p=>p.classList.toggle("active", p.dataset.mode===mode));
  buildTable();
}

function refreshAll(regen=false){
  updateRangeLabel();
  if(regen){
    state.raw = generateMockRows();
    state.kpiDeltaPct = {};
    ensureKpiDeltas();
  }
  applyFilters();
  buildKpis();
  buildCharts();
  buildTable();
}

/* ===== Init ===== */
(function init(){
  const {from,to} = defaultDateRange();
  document.getElementById("dateFrom").value = from;
  document.getElementById("dateTo").value = to;

  state.selectedWarehouses = new Set(WAREHOUSES);
  buildWarehouseMenu();
  updateWarehouseControl();
  updateRangeLabel();

  document.getElementById("whControl").addEventListener("click", (e)=>{
    if(e.target && e.target.id === "whClear") return;
    toggleWarehouseMenu();
  });
  document.getElementById("whClear").addEventListener("click", (e)=>{
    e.stopPropagation();
    state.selectedWarehouses = new Set(WAREHOUSES);
    buildWarehouseMenu();
    updateWarehouseControl();
    toggleWarehouseMenu(false);
    refreshAll(false);
  });

  document.addEventListener("click", ()=> toggleWarehouseMenu(false));
  document.getElementById("whMenu").addEventListener("click",(e)=> e.stopPropagation());

  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=> setTab(t.dataset.tab));
  });

  document.querySelectorAll(".pill").forEach(p=>{
    p.addEventListener("click", ()=> setMode(p.dataset.mode));
  });

  document.getElementById("tableSearch").addEventListener("input", ()=> buildTable());
  document.getElementById("refreshBtn").addEventListener("click", ()=> refreshAll(true));

  state.raw = generateMockRows();
  refreshAll(false);
})();
</script>
</body>
</html>


