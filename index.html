<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Перехват заказов на приемке</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg:#f6f7fb;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:#e5e7eb;
    --purple:#7c3aed;
    --purple2:#8b5cf6;
    --purpleSoft:#f1eafe;
    --shadow:0 8px 24px rgba(17,24,39,.08);
    --radius:16px;
    --good:#12b76a;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  header{
    background:linear-gradient(90deg, #8b5cf6, #7c3aed);
    color:#fff;
    position:sticky; top:0; z-index:50;
    box-shadow:0 10px 24px rgba(0,0,0,.18);
  }
  .topbar{
    max-width:1200px;
    margin:0 auto;
    padding:14px 16px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
  }
  .title{
    font-weight:900;
    font-size:18px;
    letter-spacing:.2px;
    text-align:center;
    flex:1 1 auto;
  }

  .filtersbar{
    background:#fff;
    border-bottom:1px solid var(--line);
  }
  .filters{
    max-width:1200px;
    margin:0 auto;
    padding:14px 16px;
    display:flex;
    gap:14px;
    align-items:flex-end;
    flex-wrap:wrap;
  }
  .fgroup{ display:flex; flex-direction:column; gap:6px; }
  .flabel{
    font-size:12px;
    color:var(--muted);
    font-weight:700;
  }
  .control{
    display:flex;
    align-items:center;
    gap:8px;
    background:#fff;
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px 12px;
    box-shadow:0 2px 10px rgba(17,24,39,.04);
    min-height:44px;
  }
  .control .main{ font-weight:800; color:#111827; white-space:nowrap; }
  .control .sub{ font-size:12px; color:var(--muted); margin-top:2px; white-space:nowrap; }
  .control-col{ display:flex; flex-direction:column; line-height:1.1; }
  .control .caret{
    margin-left:8px;
    width:22px;height:22px;border-radius:999px;
    display:flex;align-items:center;justify-content:center;
    background:#f3f4f6;
    color:#111827;
    font-size:12px;
    flex:0 0 auto;
  }
  .control .clear{
    width:22px;height:22px;border-radius:999px;
    display:flex;align-items:center;justify-content:center;
    background:#f3f4f6;
    color:#6b7280;
    cursor:pointer;
    flex:0 0 auto;
  }
  .daterange{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  .range-pill{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:14px;
    background:#fff;
    box-shadow:0 2px 10px rgba(17,24,39,.04);
    min-height:44px;
  }
  .range-pill .range-title{ display:flex; flex-direction:column; line-height:1.1; }
  .range-pill .range-title .main{ font-weight:900; }
  .range-pill .range-title .sub{ font-size:12px; color:var(--muted); margin-top:2px;}
  .range-pill input[type="date"]{
    border:none;
    outline:none;
    font-weight:800;
    color:#111827;
    background:transparent;
  }
  .btn{
    margin-left:auto;
    background:linear-gradient(90deg,#7c3aed,#8b5cf6);
    color:#fff;
    border:none;
    border-radius:999px;
    padding:12px 18px;
    font-weight:900;
    cursor:pointer;
    box-shadow:0 14px 28px rgba(124,58,237,.28);
    min-height:44px;
  }
  .btn:active{ transform:translateY(1px); }

  .dropdown{ position:relative; }
  .menu{
    position:absolute;
    top:52px; left:0;
    width:340px;
    max-height:340px;
    overflow:auto;
    background:#fff;
    border:1px solid var(--line);
    border-radius:14px;
    box-shadow:var(--shadow);
    display:none;
    z-index:60;
    padding:8px;
  }
  .menu.open{ display:block; }
  .menu .row{
    display:flex; align-items:center; gap:10px;
    padding:10px 10px;
    border-radius:12px;
    cursor:pointer;
  }
  .menu .row:hover{ background:#fafafa; }
  .menu input{ width:16px; height:16px; }
  .menu .row .name{ font-weight:800; }
  .menu .row .hint{ font-size:12px; color:var(--muted); margin-left:auto; }

  .container{ max-width:1200px; margin:0 auto; padding:18px 16px 26px; }

  .tabs{
    display:flex; gap:22px;
    align-items:flex-end;
    padding:10px 2px 0;
    margin-bottom:10px;
  }
  .tab{
    font-weight:900;
    color:#6b7280;
    cursor:pointer;
    padding:10px 4px;
    position:relative;
    user-select:none;
  }
  .tab.active{ color:#111827; }
  .tab.active:after{
    content:"";
    position:absolute;
    left:0; right:0; bottom:0;
    height:3px;
    border-radius:999px;
    background:var(--purple);
  }

  .kpi-grid{
    display:grid;
    grid-template-columns:repeat(3, minmax(0, 1fr));
    gap:14px;
    margin:12px 0 14px;
  }
  @media (max-width:900px){
    .kpi-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); }
    .btn{ margin-left:0; }
  }
  @media (max-width:560px){
    .kpi-grid{ grid-template-columns:1fr; }
  }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
  }
  .kpi{
    padding:14px 16px;
    min-height:84px;
    display:flex; flex-direction:column; gap:10px;
  }
  .kpi .klabel{ font-size:12px; color:var(--muted); font-weight:900; line-height:1.25; }
  .kpi .kvalue{ font-size:34px; font-weight:950; letter-spacing:.2px; }
  .kpi .kdelta{ font-size:14px; font-weight:950; color:var(--good); }

  .lane{ margin-top:12px; }
  .lane-title{
    margin:14px 0 12px;
    background:var(--purpleSoft);
    border:1px solid #e9ddff;
    color:var(--purple);
    font-weight:950;
    border-radius:14px;
    padding:12px 14px;
    text-align:center;
    letter-spacing:.2px;
  }

  .chart-card{ padding:14px 14px 12px; }
  .chart-title{ font-weight:950; font-size:14px; margin:0 0 10px; color:#374151; }
  .chart-sub{ margin:0 0 10px; font-size:12px; color:var(--muted); font-weight:800; }
  canvas{ width:100% !important; height:300px !important; }

  .table-wrap{ overflow:auto; border-radius:var(--radius); }
  table{ width:100%; border-collapse:separate; border-spacing:0; min-width:980px; }
  thead th{
    position:sticky; top:0;
    background:#fff;
    z-index:5;
    font-size:12px;
    color:#374151;
    text-align:left;
    padding:12px;
    border-bottom:1px solid var(--line);
    cursor:pointer;
    white-space:nowrap;
    font-weight:950;
  }
  tbody td{
    padding:12px;
    border-bottom:1px solid var(--line);
    font-size:12px;
    white-space:nowrap;
  }
  tbody tr:hover td{ background:#fafafa; }
  tfoot td{
    padding:12px;
    font-weight:950;
    border-top:2px solid var(--line);
    background:#fcfcff;
    position:sticky; bottom:0;
  }
  .right{ text-align:right; }
</style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="title">Заказ на приемке</div>
  </div>
</header>

<div class="filtersbar">
  <div class="filters">
    <div class="fgroup dropdown" style="min-width:340px;">
      <div class="flabel">Склад (выбрано: <span id="whCount">0</span>) *</div>
      <div class="control" id="whControl" style="cursor:pointer;">
        <div class="control-col">
          <div class="main" id="whMain">Выбраны все</div>
          <div class="sub">Мультивыбор</div>
        </div>
        <div style="flex:1"></div>
        <div class="clear" id="whClear" title="Сброс">×</div>
        <div class="caret">▾</div>
      </div>
      <div class="menu" id="whMenu"></div>
    </div>

    <div class="fgroup" style="min-width:420px; flex:1 1 auto;">
      <div class="flabel">Период *</div>
      <div class="daterange">
        <div class="range-pill" style="flex:1 1 auto; min-width:320px;">
          <div class="range-title" style="flex:1">
            <div class="main" id="rangeLabel">—</div>
            <div class="sub">Выберите диапазон дат</div>
          </div>
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <input id="dateFrom" type="date">
            <div style="font-weight:900;color:#9ca3af;">—</div>
            <input id="dateTo" type="date">
          </div>
        </div>

        <button class="btn" id="refreshBtn">⟳&nbsp; Обновить</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="tabs">
    <div class="tab active" data-tab="charts">Графики</div>
    <div class="tab" data-tab="table">Таблица</div>
  </div>

  <div class="kpi-grid" id="kpiGrid"></div>

  <div id="chartsView">
    <div class="lane">
      <div class="lane-title">Сводная по всем складам</div>

      <div class="card chart-card">
        <div class="chart-title">1. % и кол-во переданных заказов</div>
        <div class="chart-sub">Две серии (легенда кликабельна: скрывает/показывает серию)</div>
        <canvas id="c_company_34"></canvas>
      </div>

      <div style="height:12px"></div>

      <div class="card chart-card">
        <div class="chart-title">2. Экономия склада на переданных заказах</div>
        <div class="chart-sub">Одна серия</div>
        <canvas id="c_company_save"></canvas>
      </div>

      <div style="height:12px"></div>

      <div class="card chart-card">
        <div class="chart-title">3. Сумма переданных заказов в деньгах</div>
        <div class="chart-sub">Одна серия</div>
        <canvas id="c_company_sum"></canvas>
      </div>
    </div>

    <div class="lane">
      <div class="lane-title">Коледино</div>

      <div class="card chart-card">
        <div class="chart-title">1. % и кол-во переданных заказов</div>
        <div class="chart-sub">Две серии (легенда кликабельна: скрывает/показывает серию)</div>
        <canvas id="c_koledino_34"></canvas>
      </div>

      <div style="height:12px"></div>

      <div class="card chart-card">
        <div class="chart-title">2. Экономия склада на переданных заказах</div>
        <div class="chart-sub">Одна серия</div>
        <canvas id="c_koledino_save"></canvas>
      </div>

      <div style="height:12px"></div>

      <div class="card chart-card">
        <div class="chart-title">3. Сумма переданных заказов в деньгах</div>
        <div class="chart-sub">Одна серия</div>
        <canvas id="c_koledino_sum"></canvas>
      </div>
    </div>

    <div class="lane">
      <div class="lane-title">Казань</div>

      <div class="card chart-card">
        <div class="chart-title">1. % и кол-во переданных заказов</div>
        <div class="chart-sub">Две серии (легенда кликабельна: скрывает/показывает серию)</div>
        <canvas id="c_kazan_34"></canvas>
      </div>

      <div style="height:12px"></div>

      <div class="card chart-card">
        <div class="chart-title">2. Экономия склада на переданных заказах</div>
        <div class="chart-sub">Одна серия</div>
        <canvas id="c_kazan_save"></canvas>
      </div>

      <div style="height:12px"></div>

      <div class="card chart-card">
        <div class="chart-title">3. Сумма переданных заказов в деньгах</div>
        <div class="chart-sub">Одна серия</div>
        <canvas id="c_kazan_sum"></canvas>
      </div>
    </div>
  </div>

  <div id="tableView" style="display:none;">
    <div class="card" style="padding:14px;">
      <div class="table-wrap">
        <table id="dataTable">
          <thead></thead>
          <tbody></tbody>
          <tfoot></tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
const WAREHOUSES = [
  "Коледино","Казань","Челябинск","Екатеринбург","Новосибирск","Краснодар",
  "Санкт-Петербург","Ростов-на-Дону","Нижний Новгород","Самара","Тула",
  "Воронеж","Уфа","Пермь","Омск","Красноярск"
];

const state = {
  raw: [],
  filtered: [],
  sort: { key: null, dir: "desc" },
  charts: {},
  selectedWarehouses: new Set(),
  kpiDeltaPct: {}
};

function rand(min, max){ return Math.random()*(max-min)+min; }
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function fmtNum(n){ return n.toLocaleString("ru-RU"); }
function fmtPct(x){ return (x*100).toFixed(1) + "%"; }
function fmtRub(x){
  const v = Math.round(x || 0);
  return v.toLocaleString("ru-RU") + " ₽";
}

function dateKey(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }

function prettyRuDate(iso){
  const d = new Date(iso + "T00:00:00");
  const months = ["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"];
  return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()} г.`;
}

function defaultDateRange(){
  const to = new Date();
  const from = addDays(to, -27);
  return { from: dateKey(from), to: dateKey(to) };
}
function getDateRange(){
  return {
    from: document.getElementById("dateFrom").value,
    to: document.getElementById("dateTo").value
  };
}
function updateRangeLabel(){
  const {from,to} = getDateRange();
  document.getElementById("rangeLabel").textContent = `${prettyRuDate(from)} — ${prettyRuDate(to)}`;
}

/* ===== Custom multiselect ===== */
function buildWarehouseMenu(){
  const menu = document.getElementById("whMenu");
  menu.innerHTML = "";

  const mkRow = (name, checked, hint, onToggle)=>{
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <input type="checkbox" ${checked ? "checked" : ""} />
      <div class="name">${name}</div>
      <div class="hint">${hint || ""}</div>
    `;
    const cb = row.querySelector("input");
    row.addEventListener("click", (e)=>{
      if(e.target.tagName !== "INPUT") cb.checked = !cb.checked;
      onToggle(cb.checked);
      e.stopPropagation();
    });
    cb.addEventListener("click",(e)=> e.stopPropagation());
    return row;
  };

  const allChecked = state.selectedWarehouses.size === WAREHOUSES.length;
  menu.appendChild(mkRow("Выбрать все", allChecked, "", (isOn)=>{
    state.selectedWarehouses = isOn ? new Set(WAREHOUSES) : new Set();
    buildWarehouseMenu();
    updateWarehouseControl();
  }));

  const hr = document.createElement("div");
  hr.style.height="1px";
  hr.style.background="var(--line)";
  hr.style.margin="8px 0";
  menu.appendChild(hr);

  WAREHOUSES.forEach(w=>{
    const checked = state.selectedWarehouses.has(w);
    menu.appendChild(mkRow(w, checked, "", (isOn)=>{
      if(isOn) state.selectedWarehouses.add(w);
      else state.selectedWarehouses.delete(w);
      buildWarehouseMenu();
      updateWarehouseControl();
    }));
  });
}

function updateWarehouseControl(){
  const cnt = state.selectedWarehouses.size;
  document.getElementById("whCount").textContent = cnt;
  const main = document.getElementById("whMain");
  if(cnt === 0) main.textContent = "Не выбрано";
  else if(cnt === WAREHOUSES.length) main.textContent = "Выбраны все";
  else main.textContent = `Выбрано: ${cnt}`;
}

function toggleWarehouseMenu(force){
  const menu = document.getElementById("whMenu");
  const open = (typeof force === "boolean") ? force : !menu.classList.contains("open");
  menu.classList.toggle("open", open);
}

/* ===== Data ===== */
function hashCode(str){
  let h = 0;
  for(let i=0;i<str.length;i++){
    h = ((h<<5) - h) + str.charCodeAt(i);
    h |= 0;
  }
  return h;
}
function whSeed01(wh){
  const x = Math.abs(hashCode(wh)) % 1000;
  return x / 999;
}

function generateMockRows(){
  const {from, to} = getDateRange();
  const start = new Date(from);
  const end = new Date(to);

  const rows = [];
  for(let d = new Date(start); d <= end; d = addDays(d, 1)){
    const dow = d.getDay();
    const weekendFactor = (dow===0 || dow===6) ? 0.72 : 1.0;

    WAREHOUSES.forEach(wh=>{
      const whFactor =
        wh === "Коледино" ? 1.25 :
        wh === "Казань" ? 1.05 :
        wh === "Челябинск" ? 0.95 :
        wh === "Санкт-Петербург" ? 1.10 :
        wh === "Новосибирск" ? 0.92 :
        0.90 + (Math.abs(hashCode(wh)) % 20)/100;

      const orders = Math.round(rand(320, 780) * whFactor * weekendFactor);
      const unitsPerOrder = rand(1.10, 1.55);
      const units = Math.round(orders * unitsPerOrder);

      const transferRateOrders = clamp(rand(0.018, 0.085) + (whFactor-1)*0.012, 0.01, 0.14);
      const transferredAbs = Math.round(orders * transferRateOrders);

      // сохраняем в данных (не рисуем отдельным графиком)
      const sortErrRate = clamp(rand(0.002, 0.020) + (whFactor-1)*0.002 + (dow===1?0.001:0), 0.001, 0.03);

      const s = whSeed01(wh);
      const baseAov = 1400 + 2800 * s;
      const dayIndex = Math.round((d - start)/(24*3600*1000));
      const aov = baseAov * (0.95 + 0.10*Math.sin((dayIndex+1)*0.6));
      const transferredAmountRub = transferredAbs * aov;

      const savingsPerOrder = 18 + 62 * (1 - s);
      const savingsRub = transferredAbs * savingsPerOrder;

      const date = dateKey(d);
      rows.push({
        date,
        warehouse: wh,
        orders,
        units,
        transfer_rate_orders: transferRateOrders,
        transferred_abs: transferredAbs,
        sort_error_rate: sortErrRate,
        transferred_amount_rub: transferredAmountRub,
        savings_rub: savingsRub
      });
    });
  }
  return rows;
}

function applyFilters(){
  const {from, to} = getDateRange();
  state.filtered = state.raw.filter(r =>
    state.selectedWarehouses.has(r.warehouse) &&
    r.date >= from && r.date <= to
  );
}

function groupBy(arr, keyFn){
  const m = new Map();
  for(const x of arr){
    const k = keyFn(x);
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(x);
  }
  return m;
}

function agg(rows){
  const sum = (k)=> rows.reduce((a,b)=>a + (b[k]||0), 0);
  const wavg = (valKey, weightKey)=>{
    const w = rows.reduce((a,b)=>a + (b[weightKey]||0), 0);
    if(w<=0) return 0;
    return rows.reduce((a,b)=>a + (b[valKey]||0)*(b[weightKey]||0), 0)/w;
  };

  const orders = sum("orders");
  const transferredAbs = sum("transferred_abs");
  const transferRateOrders = wavg("transfer_rate_orders","orders");

  const transferredAmountRub = sum("transferred_amount_rub");
  const savingsRub = sum("savings_rub");

  return { orders, transferredAbs, transferRateOrders, transferredAmountRub, savingsRub };
}

/* ===== KPI deltas ===== */
function ensureKpiDeltas(){
  const keys = [
    "% переданных заказов",
    "кол-во переданных заказов",
    "Экономия склада на переданных заказах",
    "Сумма заказов в деньгах"
  ];
  keys.forEach(k=>{
    if(state.kpiDeltaPct[k] == null) state.kpiDeltaPct[k] = rand(0.05, 0.30);
  });
}

function buildKpis(){
  ensureKpiDeltas();
  const kpiGrid = document.getElementById("kpiGrid");
  const cur = agg(state.filtered);

  const cards = [
    { label:"% переданных заказов", value: fmtPct(cur.transferRateOrders) },
    { label:"кол-во переданных заказов", value: fmtNum(cur.transferredAbs) },
    { label:"Экономия склада на переданных заказах", value: fmtRub(cur.savingsRub) },
    { label:"Сумма заказов в деньгах", value: fmtRub(cur.transferredAmountRub) }
  ];

  kpiGrid.innerHTML = "";
  cards.forEach(c=>{
    const delta = state.kpiDeltaPct[c.label] ?? 0.12;
    const d = document.createElement("div");
    d.className = "card kpi";
    d.innerHTML = `
      <div class="klabel">${c.label}</div>
      <div class="kvalue">${c.value}</div>
      <div class="kdelta">+${(delta*100).toFixed(1)}% к предыдущему периоду</div>
    `;
    kpiGrid.appendChild(d);
  });
}

/* ===== Charts ===== */
function destroyChart(id){
  if(state.charts[id]){
    state.charts[id].destroy();
    delete state.charts[id];
  }
}
const COLORS = ["#2563eb","#7c3aed","#10b981","#f59e0b","#ef4444","#06b6d4"];

function baseOptions(){
  return {
    responsive:true,
    maintainAspectRatio:false,
    interaction:{ mode:"index", intersect:false },
    plugins:{
      legend:{ display:true, labels:{ boxWidth:18, boxHeight:10, font:{ weight:"700" } } },
      tooltip:{ enabled:true }
    },
    scales:{ x:{ ticks:{ maxRotation:45, minRotation:45 } } }
  };
}

function buildScopeCharts(scopeKey, canvas34, canvasSave, canvasSum){
  let scopedRows = [];
  if(scopeKey === "company") scopedRows = state.filtered;
  else scopedRows = state.filtered.filter(r => r.warehouse === scopeKey);

  const byDay = groupBy(scopedRows, r=>r.date);
  const labels = Array.from(byDay.keys()).sort();

  const series = labels.map(day=>{
    const a = agg(byDay.get(day));
    return {
      pct: a.transferRateOrders,
      abs: a.transferredAbs,
      savings: a.savingsRub,
      amount: a.transferredAmountRub
    };
  });

  // 1) % + count transferred
  destroyChart(canvas34);
  state.charts[canvas34] = new Chart(document.getElementById(canvas34), {
    data:{
      labels,
      datasets:[
        { type:"line", label:"% переданных заказов", data: series.map(s=>+s.pct.toFixed(4)), borderColor: COLORS[2], backgroundColor: COLORS[2], tension:0.25, pointRadius:2.2, yAxisID:"y" },
        { type:"bar",  label:"кол-во переданных заказов", data: series.map(s=>s.abs), borderColor: COLORS[0], backgroundColor:"rgba(37, 99, 235, 0.18)", yAxisID:"y1" }
      ]
    },
    options:{
      ...baseOptions(),
      scales:{
        x: baseOptions().scales.x,
        y:{ position:"left", ticks:{ callback:(v)=> (v*100).toFixed(0)+"%" }, title:{ display:true, text:"%" } },
        y1:{ position:"right", grid:{ drawOnChartArea:false }, title:{ display:true, text:"Заказы" } }
      }
    }
  });

  // 2) savings
  destroyChart(canvasSave);
  state.charts[canvasSave] = new Chart(document.getElementById(canvasSave), {
    type:"line",
    data:{
      labels,
      datasets:[
        { label:"Экономия, ₽", data: series.map(s=>Math.round(s.savings)), borderColor: COLORS[1], backgroundColor: COLORS[1], tension:0.25, pointRadius:2.2 }
      ]
    },
    options:{
      ...baseOptions(),
      plugins:{ ...baseOptions().plugins, tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmtRub(ctx.parsed.y)}` } } },
      scales:{
        x: baseOptions().scales.x,
        y:{ ticks:{ callback:(v)=> (Math.round(v)).toLocaleString("ru-RU") } }
      }
    }
  });

  // 3) amount
  destroyChart(canvasSum);
  state.charts[canvasSum] = new Chart(document.getElementById(canvasSum), {
    type:"line",
    data:{
      labels,
      datasets:[
        { label:"Сумма, ₽", data: series.map(s=>Math.round(s.amount)), borderColor: COLORS[0], backgroundColor: COLORS[0], tension:0.25, pointRadius:2.2 }
      ]
    },
    options:{
      ...baseOptions(),
      plugins:{ ...baseOptions().plugins, tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmtRub(ctx.parsed.y)}` } } },
      scales:{
        x: baseOptions().scales.x,
        y:{ ticks:{ callback:(v)=> (Math.round(v)).toLocaleString("ru-RU") } }
      }
    }
  });
}

function buildCharts(){
  buildScopeCharts("company", "c_company_34", "c_company_save", "c_company_sum");
  buildScopeCharts("Коледино", "c_koledino_34", "c_koledino_save", "c_koledino_sum");
  buildScopeCharts("Казань", "c_kazan_34", "c_kazan_save", "c_kazan_sum");
}

/* ===== TABLE: aggregated per warehouse for selected period ===== */
function buildTable(){
  const table = document.getElementById("dataTable");
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  const tfoot = table.querySelector("tfoot");

  const {from,to} = getDateRange();
  const periodLabel = `${from} — ${to}`;

  const g = groupBy(state.filtered, r => r.warehouse);

  let rows = Array.from(g.entries()).map(([warehouse, items])=>{
    const a = agg(items);
    return {
      "Склад": warehouse,
      "Период": periodLabel,
      "кол-во переданных заказов": a.transferredAbs,
      "% переданных заказов": a.transferRateOrders,
      "Экономия склада на переданных заказах": a.savingsRub,
      "Сумма переданных заказов в деньгах": a.transferredAmountRub
    };
  });

  const cols = [
    "Склад",
    "Период",
    "кол-во переданных заказов",
    "% переданных заказов",
    "Экономия склада на переданных заказах",
    "Сумма переданных заказов в деньгах"
  ];

  if(state.sort.key){
    const k = state.sort.key;
    const dir = state.sort.dir==="asc" ? 1 : -1;
    rows.sort((a,b)=>{
      const av = a[k], bv = b[k];
      if(typeof av === "number" && typeof bv === "number") return (av-bv)*dir;
      return String(av).localeCompare(String(bv))*dir;
    });
  } else {
    rows.sort((a,b)=> String(a["Склад"]).localeCompare(String(b["Склад"])));
  }

  thead.innerHTML = "<tr>" + cols.map(c=>`<th data-col="${c}">${c}</th>`).join("") + "</tr>";

  tbody.innerHTML = rows.map(r=>{
    return "<tr>" + cols.map(c=>{
      const v = r[c];

      // left for text columns
      if(c === "Склад" || c === "Период"){
        return `<td>${v}</td>`;
      }

      // right for metric columns
      let out = v;
      if(c.startsWith("% ")) out = fmtPct(v);
      else if(c.includes("Экономия") || c.includes("Сумма")) out = fmtRub(v);
      else out = fmtNum(Math.round(v));

      return `<td class="right">${out}</td>`;
    }).join("") + "</tr>";
  }).join("");

  const total = agg(state.filtered);
  const totalsRow = {
    "Склад":"Итого",
    "Период": periodLabel,
    "кол-во переданных заказов": total.transferredAbs,
    "% переданных заказов": total.transferRateOrders,
    "Экономия склада на переданных заказах": total.savingsRub,
    "Сумма переданных заказов в деньгах": total.transferredAmountRub
  };

  tfoot.innerHTML = "<tr>" + cols.map(c=>{
    const v = totalsRow[c];

    if(c === "Склад" || c === "Период"){
      return `<td>${v}</td>`;
    }

    let out = v;
    if(c.startsWith("% ")) out = fmtPct(v);
    else if(c.includes("Экономия") || c.includes("Сумма")) out = fmtRub(v);
    else out = fmtNum(Math.round(v));

    return `<td class="right">${out}</td>`;
  }).join("") + "</tr>";

  thead.querySelectorAll("th").forEach(th=>{
    th.onclick = ()=>{
      const col = th.dataset.col;
      if(state.sort.key===col){
        state.sort.dir = state.sort.dir==="asc" ? "desc" : "asc";
      } else {
        state.sort.key = col;
        state.sort.dir = "desc";
      }
      buildTable();
    };
  });
}

/* ===== Tabs ===== */
function setTab(tab){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===tab));
  document.getElementById("chartsView").style.display = (tab==="charts") ? "block" : "none";
  document.getElementById("tableView").style.display  = (tab==="table")  ? "block" : "none";
}

function refreshAll(regen=false){
  updateRangeLabel();
  if(regen){
    state.raw = generateMockRows();
    state.kpiDeltaPct = {};
    ensureKpiDeltas();
  }
  applyFilters();
  buildKpis();
  buildCharts();
  buildTable();
}

/* ===== Init ===== */
(function init(){
  const {from,to} = defaultDateRange();
  document.getElementById("dateFrom").value = from;
  document.getElementById("dateTo").value = to;

  state.selectedWarehouses = new Set(WAREHOUSES);
  buildWarehouseMenu();
  updateWarehouseControl();
  updateRangeLabel();

  document.getElementById("whControl").addEventListener("click", (e)=>{
    if(e.target && e.target.id === "whClear") return;
    toggleWarehouseMenu();
  });
  document.getElementById("whClear").addEventListener("click", (e)=>{
    e.stopPropagation();
    state.selectedWarehouses = new Set(WAREHOUSES);
    buildWarehouseMenu();
    updateWarehouseControl();
    toggleWarehouseMenu(false);
    refreshAll(false);
  });

  document.addEventListener("click", ()=> toggleWarehouseMenu(false));
  document.getElementById("whMenu").addEventListener("click",(e)=> e.stopPropagation());

  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=> setTab(t.dataset.tab));
  });

  document.getElementById("refreshBtn").addEventListener("click", ()=> refreshAll(true));

  state.raw = generateMockRows();
  refreshAll(false);
})();
</script>
</body>
</html>
